version: "3.9"

services:
  ui:
    build:
      context: ../machine-ui-heroui-shadcn
    ports:
      - "3000:3000"
    env_file:
      - ./env/ui.env
    environment:
      NEXT_PUBLIC_MQTT_URL: "ws://mqtt:9001"
      NEXT_PUBLIC_MQTT_USERNAME: "${MQTT_USERNAME}"
      NEXT_PUBLIC_MQTT_PASSWORD: "${MQTT_PASSWORD}"
    depends_on:
      - mqtt
    restart: unless-stopped

  bridge:
    build:
      context: ../machine-bridge
    env_file:
      - ./env/bridge.env
    environment:
      MQTT_URL: "mqtt://mqtt:1883"
      OPCUA_ENDPOINT: "${OPCUA_ENDPOINT}"
      OPCUA_SECURITY_MODE: "None"
    depends_on:
      - mqtt
    restart: unless-stopped
    # (No ports exposed â€” this is an internal bridge only)

  # ros2node:
  #   build:
  #     context: ./services/ros2node
  #   env_file:
  #     - .env
  #   environment:
  #     MQTT_URL: "mqtt://mqtt:1883"
  #   depends_on:
  #     - mqtt
  #   restart: unless-stopped

  machine-vision:
    build:
      context: ../machine-vision
    env_file:
      - ./env/vision.env
    volumes:
      - ./vision-data:/data
    devices:
      - "/dev/video0:/dev/video0"   # optional; only if you want host device passed through
    depends_on:
      - broker
      - mongodb

  mqtt:
    image: eclipse-mosquitto:2
    container_name: mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
      - "9002:9002"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log

  mongodb:
    image: mongo:7
    container_name: mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"
    restart: unless-stopped

volumes:
  mongo_data:
